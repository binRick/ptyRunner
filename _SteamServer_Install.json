[{"gem":"name={{item}} state=present","with_items":["teamocil"]},{"npm":"name={{item}} state=present global=True","with_items":["prettyjson","underscore-cli"]},{"name":"Deploying Steam required software","yum":"name={{item}} state=present","with_items":["mailx","postfix","glibc.i686","libstdc++.i686"]},{"name":"Creating Steam User","user":"name={{SteamServer.User.Name}} shell={{SteamServer.User.Shell}} home={{SteamServer.User.Home}} generate_ssh_key=yes ssh_key_bits=2048 ssh_key_file=.ssh/id_rsa"},{"debug":"var={{SteamServer}}"},{"name":"Downloading Gibbs script","get_url":"url={{SteamServer.Gibbs.Url}}{{SteamServer.Gibbs.Installer}} dest={{SteamServer.User.Home}}/{{SteamServer.Gibbs.Installer}}"},{"file":"path={{SteamServer.User.Home}}/{{SteamServer.Gibbs.Installer}} mode=0755 owner={{SteamServer.User.Name}} group={{SteamServer.User.Name}}"},{"file":"path=/root/.ssh/id_rsa.pub mode=0700 owner=root group=root"},{"file":"path=/root/.ssh mode=0700 owner=root group=root"},{"name":"Retrieving root pub key","shell":"cat /root/.ssh/id_rsa.pub 2>/dev/null","register":"rootKey"},{"name":"Adding keys to steam user authorized_keys","authorized_key":"user=\"{{SteamServer.User.Name}}\" key=\"{{ rootKey.stdout }}\" state=present"},{"name":"Adding keys to steam users authorized_keys on host {{hostvars[item]}}","authorized_key":"user=\"{{SteamServer.User.Name}}\" key=\"{{ rootKey.stdout }}\" state=present","delegate_to":"{{item}}","with_items":"groups['steamServers']"},{"name":"Adding keys to root user authorized_keys on host {{item}}","authorized_key":"user=root key=\"{{ rootKey.stdout }}\" state=present","delegate_to":"{{item}}","with_items":"groups['steamServers']"},{"name":"Ensure TLD in resolv.conf search","tags":"R","lineinfile":"regexp=\"^search \" line=\"search {{tld}}\" dest=\"/etc/resolv.conf\" state=present\n"},{"name":"Ensure Inventory Items in hosts","with_items":"groups['steamServers']","tags":"R","lineinfile":"regexp=\"^{{hostvars[item].ansible_ssh_host}} \" line=\"{{hostvars[item].ansible_ssh_host}} {{item}} {{item}}.{{tld}}\" dest=\"/etc/hosts\" state=present\n"},{"name":"test local root to user ssh connection","command":"ssh -o StrictHostKeyChecking=no {{SteamServer.User.Name}}@127.0.0.1 id"},{"name":"test root ssh connection to localhost","command":"ssh -o StrictHostKeyChecking=no root@127.0.0.1 id"},{"name":"test resolution of steamServers","with_items":"groups['steamServers']","command":"host {{item}}"},{"name":"test root ssh connection to steamServers","with_items":"groups['steamServers']","command":"ssh -o StrictHostKeyChecking=no root@{{item}} id"},{"name":"test steam users ssh connection to steamServers","with_items":"groups['steamServers']","command":"ssh -o StrictHostKeyChecking=no {{SteamServer.User.Name}}@{{item}} id"},{"replace":"dest={{SteamServer.User.Home}}/{{SteamServer.Gibbs.Installer}} regexp='^steamuser=\"(.*)\"$' replace='steamuser=\"{{SteamServer.SteamUsername}}\"'"},{"replace":"dest={{SteamServer.User.Home}}/{{SteamServer.Gibbs.Installer}} regexp='^steampass=\"(.*)\"$' replace='steampass=\"{{SteamServer.SteamPassword}}\"'"},{"replace":"dest={{SteamServer.User.Home}}/{{SteamServer.Gibbs.Installer}} regexp='^ip=\"(.*)\"$' replace='ip=\"{{SteamServer.IP}}\"'"},{"replace":"dest={{SteamServer.User.Home}}/{{SteamServer.Gibbs.Installer}} regexp='^email=\"(.*)\"$' replace='email=\"{{SteamServer.Email}}\"'"},{"replace":"dest={{SteamServer.User.Home}}/{{SteamServer.Gibbs.Installer}} regexp='^emailnotification=\"(.*)\"$' replace='emailnotification=\"{{SteamServer.EmailNotifications|default('off')}}\"'"},{"file":"path=/root/.teamocil mode=0700 owner=root group=root state=directory"}]
